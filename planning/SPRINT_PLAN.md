# Sprint Plan: v3.1 Bugfixes and Improvements

This sprint focuses on improving the stability, reliability, and testability of the Editorial Assistant v3.0 application. The highest priority is to add test coverage for the most critical and untested parts of the application.

## High Priority

| Task ID | Description | Agent Assignment | Exit Criteria |
|---|---|---|---|
| **TEST-001** | **Add tests for the JobWorker.** Create a new test file `tests/api/test_worker.py` and add comprehensive tests for the `JobWorker` in `api/services/worker.py`. The tests should cover the worker's state machine, phase transitions, error handling and recovery logic, and interaction with the LLM client (using mocking). | Orchestrator | - New file `tests/api/test_worker.py` created.<br>- All public methods of `JobWorker` have test cases.<br>- Happy path, error handling, and recovery scenarios are covered.<br>- Mocking used for external dependencies (database, LLM client). |
| **TEST-002** | **Add tests for the API endpoints.** Create new test files in `tests/api` to test the FastAPI routers. The tests should cover all endpoints in `jobs.py` and `queue.py`, including valid and invalid inputs, and expected HTTP status codes. | Orchestrator | - New test files created for `api/routers/jobs.py` and `api/routers/queue.py`.<br>- All API endpoints respond with correct data and status codes for valid requests.<br>- Error cases (e.g., 404 Not Found, 400 Bad Request) are tested.<br>- Input validation (e.g., Pydantic models) is implicitly covered. |
| **BUG-001** | **Fix potential race condition in `claim_next_job`.** The current implementation of `claim_next_job` in `api/services/database.py` uses a `SELECT` followed by an `UPDATE`, which is not atomic and could lead to a race condition if multiple workers try to claim the same job simultaneously. Refactor this to use a single atomic `UPDATE ... RETURNING` statement. | Orchestrator | - `claim_next_job` function in `api/services/database.py` is refactored to use an atomic `UPDATE ... RETURNING` statement.<br>- Existing tests for `claim_next_job` pass.<br>- No new race conditions introduced. |
| **IMPROVE-001**| **Improve `run_worker.py` to load defaults from the config file.** The `run_worker.py` script has hardcoded defaults for poll_interval, heartbeat_interval and max_concurrent_jobs. These should be loaded from the `config/llm-config.json` file. | CLI-Agent/Gemini | - `run_worker.py` correctly loads `poll_interval_seconds`, `heartbeat_interval_seconds`, and `max_concurrent_jobs` from `config/llm-config.json` (if present).<br>- CLI arguments still override config file settings.<br>- `README.md` or a new `docs/CONFIGURATION.md` is updated to reflect worker configuration options. |

## Medium Priority

| Task ID | Description | Agent Assignment | Exit Criteria |
|---|---|---|---|
| **TEST-003** | **Add tests for the LLMClient.** Create a new test file `tests/api/test_llm.py` and add tests for the `LLMClient` in `api/services/llm.py`. Use mocking to simulate the different LLM backends and test the client's ability to handle API errors, track costs, and perform model selection. | Orchestrator | - New file `tests/api/test_llm.py` created.<br>- All public methods of `LLMClient` are tested.<br>- Mocking effectively simulates LLM API responses and errors.<br>- Cost tracking, model selection, and safety guard logic are verified. |
| **TEST-004** | **Add tests for `watch_transcripts.py`.** Create a new test file `tests/test_watch_transcripts.py` and add tests for the file watcher. The tests should cover detecting new files, queueing them for processing, and handling already queued files. | CLI-Agent/Gemini | - New file `tests/test_watch_transcripts.py` created.<br>- Tests cover new file detection, queueing (mocking API call), and handling of existing/queued files.<br>- Edge cases like empty directories, invalid file types are considered. |
| **BUG-002** | **Handle `project_path` creation in `create_job` more robustly.** The `create_job` function in `api/services/database.py` derives the `project_path` from the `project_name`. This could lead to issues if the `project_name` contains characters that are invalid in file paths. The sanitization of the project name needs to be improved. | CLI-Agent/Gemini | - `project_name` sanitization in `create_job` is robust against problematic characters (e.g., `/`, `
`, `:`, `*`, `?`, `